version: "3.3"
services:
  requirements:
    container_name: giscube_admin_requirements
    build:
      context: .
      dockerfile: docker/django/Dockerfile
      args:
        - EXTRA_REQUIREMENTS=${ENVIRONMENT_NAME}
        - USER_UID=${USER_UID}
        - DOCKER_USER=${DOCKER_USER}
    image: giscube_admin_requirements
    entrypoint:
      - /bin/bash
    command: []

  db:
    container_name: giscube_admin_db
    build:
      context: docker/db/
      dockerfile: Dockerfile
    image: giscube_admin_db
    env_file:
     - .env
     - app.env
    command: ["/bin/bash", "/app/docker/db/postgresql10.sh"]
    volumes:
      - .:/app
      - postgresql_data:/var/lib/postgresql/

  django:
    container_name: giscube_admin_django
    depends_on:
      - db
    image: giscube_admin_requirements
    env_file:
     - .env
     - app.env
    command: ["/bin/bash", "/app/docker/wait-for.sh", "db:5432", "--", "/bin/bash", "/app/docker/django/runserver.sh"]
    # command: ["/bin/bash", "/app/docker/wait-for.sh", "db:5432", "--", "/bin/bash", "/app/docker/django/uwsgi.sh"]
    volumes:
      - .:/app
      - ./docker_data/django:/docker_data
    ports:
      - "8000:8000"

  celery:
    container_name: giscube_admin_celery
    hostname: celery
    depends_on:
      - redis
      - db
    image: giscube_admin_requirements
    env_file:
     - .env
     - app.env
    command: ["/bin/bash", "/app/docker/wait-for.sh", "db:5432", "--",  "/bin/bash", "/app/docker/django/celery_devel.sh"]
    volumes:
      - .:/app
      - ./docker_data/django:/docker_data

  redis:
    container_name: giscube_admin_redis
    hostname: giscube_admin_redis
    image: redis:latest
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data

  nginx:
    container_name: giscube_admin_nginx
    build:
      context: docker/nginx/
      dockerfile: Dockerfile
    image: giscube_admin_nginx
    ports:
      - "8080:8080"

  qgisserver:
    container_name: giscube_admin_qgisserver
    build:
      context: docker/qgisserver/
      dockerfile: Dockerfile
    image: giscube_admin_qgisserver
    volumes:
      - ./docker_data/django:/docker_data

  imageserver:
    container_name: giscube_admin_imageserver
    build:
      context: docker/imageserver/
      dockerfile: Dockerfile
    image: giscube_admin_imageserver
    environment:
        - MS_DEBUGLEVEL=5
        - MS_ERRORFILE=/docker_data/ms_error.txt
    volumes:
      - ./docker_data/django:/docker_data

volumes:
  postgresql_data:
  redis_data:
